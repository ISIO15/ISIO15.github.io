
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP & M5 Flasher</title>
    <script type="module" src="install-button.js"></script>
    
    <style>
        :root {
            --primary: #9d4edd;
            --primary-dark: #7b2cbf;
            --bg-dark: #1a1a2e;
            --text-light: #e6e6fa;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: rgba(41, 41, 61, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
            max-width: 900px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .device-selector {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: rgba(157, 78, 221, 0.1);
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .device-option {
            padding: 15px;
            background: rgba(157, 78, 221, 0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .device-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .device-option.selected {
            border-color: var(--primary);
            background: rgba(157, 78, 221, 0.3);
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            background: rgba(157, 78, 221, 0.1);
        }

        .custom-file-upload {
            display: inline-block;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin-bottom: 20px;
        }

        .custom-file-upload:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        #flash-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #flash-button:hover {
            background: linear-gradient(45deg, var(--primary-dark), var(--primary));
            transform: translateY(-2px);
        }

        #flash-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        #log-panel {
            margin-top: 30px;
            padding: 20px;
            background: rgba(26, 26, 46, 0.9);
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            border: 1px solid var(--primary);
        }

        .log-entry {
            margin: 5px 0;
            color: #a0a0a0;
        }

        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
    </style>
    
</head>
<body>
    <div class="container">
        <h1>ESP & M5 Firmware Flasher</h1>
        
        <div class="device-selector">
            <h3>Выберите устройство:</h3>
            <div class="device-grid">
                <div class="device-option" data-chip="ESP32">
                    <div>ESP32</div>
                </div>
                <div class="device-option" data-chip="ESP32-S2">
                    <div>ESP32-S2</div>
                </div>
                <div class="device-option" data-chip="ESP32-S3">
                    <div>ESP32-S3</div>
                </div>
                <div class="device-option" data-chip="ESP32-C3">
                    <div>ESP32-C3</div>
                </div>
                <div class="device-option" data-chip="ESP8266">
                    <div>ESP8266/D1 Mini</div>
                </div>
                <div class="device-option" data-chip="ESP32-S3">
                    <div>M5 Cardputer</div>
                </div>
                <div class="device-option" data-chip="ESP32">
                    <div>M5StickC/Plus</div>
                </div>
                <div class="device-option" data-chip="ESP32-S3">
                    <div>AtomS3</div>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <input type="file" id="firmware" accept=".bin" style="display: none">
            <label for="firmware" class="custom-file-upload">
                Выбрать файл прошивки
            </label>
            <div id="file-name"></div>
        </div>

        <esp-web-install-button id="install-button">
            <button slot="activate" id="flash-button" disabled>Выберите устройство и прошивку</button>
        </esp-web-install-button>

        <div id="log-panel">
            <div class="log-entry">Лог прошивки:</div>
        </div>
    </div>

    
    <script>
   
let selectedDevice = null;
let firmwareFile = null;
const deviceOptions = document.querySelectorAll('.device-option');
const flashButton = document.getElementById('flash-button');
const installButton = document.getElementById('install-button');


// Функция для создания manifest
function createManifest(chipFamily, firmwarePath) {
    return {
        name: `${chipFamily} Firmware`,
        version: "1.0",
        new_install_prompt_erase: true,
        reset: "hard",
        reset_delay: 1500,
        double_reset: true,
        builds: [
            {
                chipFamily: chipFamily,
                parts: [
                    { path: firmwarePath, offset: 0 }
                ]
            }
        ]
    };
}


function createManifestUrl(manifest) {
    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    return URL.createObjectURL(blob);
}

deviceOptions.forEach(option => {
    option.addEventListener('click', () => {
        deviceOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedDevice = option.dataset.chip;
        addLog(`Выбрано устройство: ${selectedDevice}`, 'info');
        
        if (firmwareFile) {
            updateInstallButton();
        }
        
        updateFlashButton();
    });
});

document.getElementById('firmware').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) {
        addLog('Выбор файла отменен', 'warning');
        return;
    }

    addLog(`Выбран файл прошивки: ${file.name}`, 'info');
    document.getElementById('file-name').textContent = file.name;
    firmwareFile = file;

    if (selectedDevice) {
        updateInstallButton();
    }
    
    updateFlashButton();
});

function updateFlashButton() {
    flashButton.disabled = !selectedDevice || !firmwareFile;
    const status = flashButton.disabled ? 
        'Выберите устройство и прошивку' : 
        `Прошить ${selectedDevice}`;
    flashButton.textContent = status;
    
    if (flashButton.disabled) {
        if (!selectedDevice && !firmwareFile) {
            addLog('Ожидание выбора устройства и файла прошивки', 'warning');
        } else if (!selectedDevice) {
            addLog('Ожидание выбора устройства', 'warning');
        } else if (!firmwareFile) {
            addLog('Ожидание выбора файла прошивки', 'warning');
        }
    } else {
        addLog('Система готова к прошивке', 'success');
    }
}

async function updateInstallButton() {
    try {
        addLog('Подготовка файлов для прошивки...', 'info');
        
        const firmwareUrl = URL.createObjectURL(firmwareFile);
        addLog(`Файл прошивки подготовлен: ${firmwareFile.name}`, 'info');
        
        const manifest = createManifest(selectedDevice, firmwareUrl);
        addLog(`Манифест создан для ${selectedDevice}`, 'info');
        
        const manifestUrl = createManifestUrl(manifest);
        addLog('Манифест подготовлен', 'info');
        
        installButton.manifest = manifestUrl;
        addLog('Установщик готов к работе', 'success');

        installButton.addEventListener('closed', () => {
            URL.revokeObjectURL(firmwareUrl);
            URL.revokeObjectURL(manifestUrl);
            addLog('Ресурсы очищены', 'info');
        }, { once: true });
    } catch (error) {
        addLog(`Ошибка подготовки: ${error.message}`, 'error');
    }
}

function addLog(message, type = 'info') {
    const logPanel = document.getElementById('log-panel');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logPanel.appendChild(logEntry);
    logPanel.scrollTop = logPanel.scrollHeight;
}

installButton.addEventListener('esp-web-install-error', (e) => {
    addLog(`Ошибка: ${e.detail.error}`, 'error');
});

installButton.addEventListener('esp-web-install-progress', (e) => {
    addLog(`Прогресс: ${e.detail.progress}%`, 'info');
});

installButton.addEventListener('esp-web-install-success', () => {
    addLog('Прошивка успешно завершена!', 'success');
});

installButton.addEventListener('esp-web-connect-success', (e) => {
    addLog(`Устройство подключено: ${e.detail.port.device.productName}`, 'success');
});

installButton.addEventListener('esp-web-connect-error', (e) => {
    addLog(`Ошибка подключения: ${e.detail.error}`, 'error');
});

installButton.addEventListener('esp-web-flash-progress', (e) => {
    const progress = Math.round(e.detail.progress * 100);
    addLog(`Прогресс прошивки: ${progress}%`, 'info');
});

installButton.addEventListener('install-finished', () => {
    addLog('Установка успешно завершена!', 'success');
});


document.addEventListener('DOMContentLoaded', () => {
    addLog('Система инициализирована. Выберите устройство и файл прошивки.', 'info');
});


window.onerror = function(msg, url, lineNo, columnNo, error) {
    addLog(`Системная ошибка: ${msg}`, 'error');
    return false;
};


window.onunhandledrejection = function(event) {
    addLog(`Необработанная ошибка: ${event.reason}`, 'error');
};
</script>
</body>
</html>
